<!DOCTYPE html>
<html lang="en">
<head>
    <title>Calling an OPC UA method</title>
    <link rel="stylesheet" href="C:\Projects\AS\BR\easyuaclient-as-project-dev-local\Help\EasyUaClnt\Logical\EasyUaClnt\styles.css">
    <base href="C:/Projects/AS/BR/easyuaclient-as-project-dev-local/Help/EasyUaClnt/Logical/_Base/" target="_blank">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="ORDER" content="0">
</head>
<body>
    <h1>Calling an OPC UA Method Using EasyUaMethodCall</h1>
    <p>Program examples are developed on ARsim, B&R's simulation PLC.</p>

    <h2>Preparing the OPC UA Client</h2>
    <p>The OPC UA client is enabled in the Configuration View, under the active configuration, in the following file: <strong>Connectivity > OpcUaCs > UaCsConfig.uacfg</strong>.</p>
    <p>Parameter <strong>"OPC UA Client/Server"</strong> is set to <strong>"Enabled"</strong>. The parameter TCP port number is set to <strong>4841</strong>.</p>
    <p><img src="_img/enableopcuaclient1.png" alt="Enable OPC UA Client"></p>

    <h2>Adding EasyUaClt Library</h2>
    <p>In order to run the sample, EasyUaClt has to be imported using <strong>Toolbox > Existing Library</strong>.</p>
    <p><img src="_img/importeasyuacltlibrary.png" alt="Import EasyUaClt Library"></p>

    <h2>Sample Program on the Client</h2>
    <p>Program example <strong>"MethodCall"</strong> runs on the PLC implementing the FUB EasyUaMethodCall. It can be saved using the following link. Then it has to be imported into the client Automation Studio project.</p>
    <p><a href="_zip/MethodCall.zip" target="_self">MethodCall Sample Task</a></p>

    <h2>Calling an OPC UA Method</h2>
    <p>The OPC UA server implements the method Multiply. Call function "::MethodTask:Multiply" on the OPC UA server, specify parameters "VarA" and "VarB" and save the result in "VarC". The code on the server side regarding this operation is:</p>
    <pre class="SourceCode">
<font color="#0000FF" name="Courier" new="">PROGRAM _CYCLIC</font>
    CASE Step OF
        0:
            UaSrv_MethodOperate_0.Action := UaMoa_CheckIsCalled; 
            UaSrv_MethodOperate_0.MethodName := 'Multiply';
            UaSrv_MethodOperate_0.Execute := TRUE;
            Step := 1;
        1:
            UaSrv_MethodOperate_0();
            IF UaSrv_MethodOperate_0.Busy THEN
                UaSrv_MethodOperate_0.Execute := FALSE;
            ELSE
                IF UaSrv_MethodOperate_0.Done THEN
                    IF UaSrv_MethodOperate_0.IsCalled THEN
                        Step := 2;
                    END_IF
                    UaSrv_MethodOperate_0.Execute := TRUE;
                END_IF
                IF UaSrv_MethodOperate_0.Error THEN
                    Step := 0;
                END_IF
            END_IF
        2:
            VarResult := VarA * VarB;
            Step := 3;
        3:
            UaSrv_MethodOperate_0.Action := UaMoa_Finished;
            UaSrv_MethodOperate_0.MethodName := 'Multiply';
            UaSrv_MethodOperate_0.Execute := TRUE;
            Step := 4;
        4:
            UaSrv_MethodOperate_0();
            IF UaSrv_MethodOperate_0.Busy THEN
                UaSrv_MethodOperate_0.Execute := FALSE;
            ELSE
                IF UaSrv_MethodOperate_0.Done THEN
                    Step := 0;
                END_IF
                IF UaSrv_MethodOperate_0.Error THEN
                    Step := 0;
                END_IF
            END_IF
    END_CASE;
<font color="#0000FF" name="Courier" new="">END_PROGRAM</font>
    </pre>
    <p>Calling the method can be done by executing the FUB <strong>EasyUaMethodCall_0</strong> by setting <strong>EasyUaMethodCall_0.Execute</strong> to <strong>TRUE</strong>. This can be done from the Watch window of the MethodCall task.</p>
    <p><img src="_img/methodcallexecution.png" alt="Method Call Execution"></p>
</body>
</html>
